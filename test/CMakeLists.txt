# ##############################################################################
# Find dependencies
# ##############################################################################
find_package(GTest QUIET)
if(NOT GTest_FOUND)
  include(FetchContent)
  set(INSTALL_GTEST OFF)
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/054a986a8513149e8374fc669a5fe40117ca6b41.zip
  )
  # For Windows: Prevent overriding the parent project's compiler/linker
  # settings
  set(gtest_force_shared_crt
      ON
      CACHE BOOL "" FORCE)
  FetchContent_MakeAvailable(googletest)
endif()

find_package(
  Boost 1.74.0
  COMPONENTS
  REQUIRED)

# ##############################################################################
# Specify source files
# ##############################################################################
set(TEST_MAIN ${CMAKE_CURRENT_SOURCE_DIR}/main.cpp)

set(UNIT_SRC ${CMAKE_CURRENT_SOURCE_DIR}/unit)
set(UNIT_SRC_FILES
    ${TEST_MAIN}
    ${UNIT_SRC}/test_diagnostics.cpp
    ${UNIT_SRC}/test_fft_mkl.cpp
    ${UNIT_SRC}/test_mesh.cpp
    ${UNIT_SRC}/test_plasma.cpp
    ${UNIT_SRC}/test_species.cpp
    ${UNIT_SRC}/nektar_interface/test_geometry_transport_2d.cpp)

set(INTEGRATION_SRC ${CMAKE_CURRENT_SOURCE_DIR}/integration)
set(INTEGRATION_SRC_FILES
    ${TEST_MAIN} ${INTEGRATION_SRC}/test_mms.cpp
    ${INTEGRATION_SRC}/solvers/solver_test_utils.cpp
    ${INTEGRATION_SRC}/solvers/SimpleSOL/test_SimpleSOL.cpp)

# ##############################################################################
# Set up targets
# ##############################################################################
# Remove coverage flags
list(REMOVE_ITEM BUILD_TYPE_COMPILE_FLAGS "--coverage")
list(REMOVE_ITEM TEST_LIBRARIES "gcov")

# Build the unit test suite
set(UNIT_EXE unitTests)
add_executable(${UNIT_EXE} ${UNIT_SRC_FILES})
target_link_libraries(${UNIT_EXE} PRIVATE ${LIBRARY_NAME} GTest::gtest)
add_sycl_to_target(TARGET ${UNIT_EXE} SOURCES ${UNIT_SRC_FILES})
gtest_add_tests(TARGET ${UNIT_EXE})

# Build the integration test suite
set(INTEGRATION_EXE integrationTests)
add_executable(${INTEGRATION_EXE} ${INTEGRATION_SRC_FILES})
target_include_directories(${INTEGRATION_EXE}
                           PRIVATE ${INTEGRATION_SRC}/solvers)
target_link_libraries(
  ${INTEGRATION_EXE} PRIVATE ${LIBRARY_NAME} ${SOLVER_LIBS} GTest::gmock_main
                             GTest::gtest Boost::boost)

# Define the integration test executable as a sycl target
add_sycl_to_target(TARGET ${INTEGRATION_EXE} SOURCES ${TEST_MAIN}
                   ${INTEGRATION_SRC_FILES})
# Register tests with CTest
gtest_add_tests(TARGET ${INTEGRATION_EXE})
